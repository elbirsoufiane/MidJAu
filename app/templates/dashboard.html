{% extends "base.html" %}

{% block title %}Dashboard | MidjyAuto{% endblock %}

{% block content %}

<h2 class="title">üìä Dashboard</h2>

<form method="POST" enctype="multipart/form-data" onsubmit="return handleSubmit();">
    <label class="form-label">Upload Prompts File (.xlsx):</label>
    <input type="file" name="prompt_file" id="fileInput" required>

    <label class="form-label" style="margin-top: 30px;">Select Mode:</label>
    <div id="modeButtons" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
        <input type="hidden" name="mode" id="selectedMode" value="{{ selected_mode }}">
        {% for mode in ['U1', 'U2', 'U3', 'U4', 'All'] %}
        <button
            type="button"
            class="mode-btn {% if selected_mode == mode %}selected{% endif %}"
            data-mode="{{ mode }}">{{ mode }}</button>
        {% endfor %}
    </div>

    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
      <button type="submit" id="run-script-btn" class="save-btn">Start</button>
      <button type="button" id="cancel-script-btn" class="save-btn">Cancel</button>
    </div>

      <div id="queue-eta-area" style="text-align:center; margin-top:10px;">
        {% if queue_position is not none and queue_position > 0 %}
          <p><b>Queued in {{ queued_mode }} ‚Äì position {{ queue_position }}, ~{{ queue_eta_minutes }} min to start</b></p>
        {% else %}
          <p>Not running! Upload an Excel file, select your mode and hit Start.</p>
        {% endif %}
      </div>

    <div id="job-eta-box" style="text-align:center; margin-top:5px;"></div>
</form>

<h3 style="margin-top: 40px;">üñ® Output:</h3>
<div class="output-box" id="outputBox" style="max-width: 800px; max-height: 200px; margin: auto;">Waiting to start...</div>

<button onclick="clearOutput()" class="save-btn" style="margin: 20px auto 0 auto; display: block;">üßπ Clear Output</button>
<div id="status-msg" style="margin-top: 10px; font-style: italic; text-align: center;"></div>
<div id="login-flag" data-just-logged-in="{{ just_logged_in | lower }}"></div>

<script>
  let outputCleared = false;
  let suppressDownload = true;
  const justLoggedIn = document.getElementById("login-flag")?.dataset.justLoggedIn === "true";

  if (justLoggedIn && localStorage.getItem("scriptRunning") !== "true") {
    localStorage.setItem("scriptRunning", "false");
    sessionStorage.removeItem("scriptStarted");
  }

  if (sessionStorage.getItem("scriptStarted") === "true") {
    suppressDownload = false;
  }

  if (justLoggedIn) {
    const loginFlagDiv = document.getElementById("login-flag");
    if (loginFlagDiv) {
      loginFlagDiv.dataset.justLoggedIn = "false";
    }
  }

  const runBtn = document.getElementById("run-script-btn");
  const clearBtn = document.querySelector('button[onclick="clearOutput()"]');
  const outputBox = document.getElementById("outputBox");
  let jobProgressInterval = null;

  // Live ETA update from backend
  function updateQueueEta() {
    fetch('/queue_eta')
      .then(res => res.json())
      .then(data => {
        let msg = "";
        const mode = document.getElementById("selectedMode")?.value || "";
        const etaBox = document.getElementById("job-eta-box");
        if (data.num_workers === 0) {
          msg = "<b>No workers are currently available. Please try again later.</b>";
          if (jobProgressInterval) {
            clearInterval(jobProgressInterval);
            jobProgressInterval = null;
            if (etaBox) etaBox.innerHTML = "";
          }
        } else if (data.position === 0) {
          msg = "<b>Your job is running now!</b>";
          if (!jobProgressInterval) {
            updateJobProgress();
            jobProgressInterval = setInterval(updateJobProgress, 3000);
          }
        } else if (data.position > 0) {
          msg = `<b>Queued in ${mode} ‚Äì position ${data.position}, ~${data.eta_minutes} min to start</b>`;
          if (jobProgressInterval) {
            clearInterval(jobProgressInterval);
            jobProgressInterval = null;
            if (etaBox) etaBox.innerHTML = "";
          }
        } else {
          msg = "Not running! Upload an Excel file, select your mode and hit Start";
          if (jobProgressInterval) {
            clearInterval(jobProgressInterval);
            jobProgressInterval = null;
            if (etaBox) etaBox.innerHTML = "";
          }
        }
        document.getElementById("queue-eta-area").innerHTML = "<p>" + msg + "</p>";
      })
      .catch(e => {
        // Optionally handle fetch errors
        console.error("Queue ETA update failed:", e);
      });
  }
  setInterval(updateQueueEta, 3000);  // every 10 seconds
  updateQueueEta();  // also run on page load


  function updateJobProgress() {
    fetch('/job_progress')
      .then(res => res.json())
      .then(data => {
        let etaBox = document.getElementById("job-eta-box");
        if (!etaBox) return;
        if (data.status === "running") {
          const min = Math.ceil(data.remaining_seconds / 60);
          etaBox.innerHTML = `<b>Estimated time remaining: ${min} min</b> (${data.completed_prompts} / ${data.total_prompts} prompts done)`;
        } else {
          etaBox.innerHTML = "";
        }
      })
      .catch(() => {
        // Optionally show "unknown" state
        document.getElementById("job-eta-box").innerHTML = "";
      });
  }



  // Persist state across page reloads using localStorage
  if (localStorage.getItem("scriptRunning") === "true") {
    runBtn.disabled = true;
    runBtn.textContent = "Processing...";
    clearBtn.disabled = true;
    clearBtn.textContent = "Processing...";
  }

  if ({{ start_failed|default(false)|tojson }}) {
    localStorage.setItem("scriptRunning", "false");
    sessionStorage.removeItem("scriptStarted");
    runBtn.disabled = false;
    runBtn.textContent = "Start";
    clearBtn.disabled = false;
    clearBtn.textContent = "üßπ Clear Output";
  }

  function handleSubmit() {
    localStorage.setItem("scriptRunning", "true");
    sessionStorage.setItem("scriptStarted", "true");
    runBtn.disabled = true;
    runBtn.textContent = "Processing...";
    clearBtn.disabled = true;
    clearBtn.textContent = "Processing...";
    return true;
  }

  function clearOutput() {
    outputCleared = true;
    if (localStorage.getItem("scriptRunning") !== "true") {
      outputBox.textContent = '';
    }
  }

  // Poll for log updates
  let scriptJustCompleted = false;

  setInterval(() => {
    if (outputCleared) return;
    fetch("/live_output")
      .then(response => response.text())
      .then(data => {
        outputBox.textContent = data || "Waiting to start...";
        outputBox.scrollTop = outputBox.scrollHeight;

        if (data.includes("‚úÖ Execution completed.") && !scriptJustCompleted) {
          localStorage.setItem("scriptRunning", "false");
          runBtn.disabled = false;
          runBtn.textContent = "Start";
          clearBtn.disabled = false;
          clearBtn.textContent = "üßπ Clear Output";
        }

        if (data.includes("‚úÖ Execution completed.") && !scriptJustCompleted && !suppressDownload) {
          scriptJustCompleted = true;
          const flashDiv = document.getElementById("flash-message");
          if (flashDiv) flashDiv.remove();
          showToast("üü¢ Images have been generated successfully!", "success");
          setTimeout(() => {
            window.location.href = "/download_zip";
            fetch("/download_failed_prompts_excel", { method: "HEAD" })
              .then(res => {
                if (res.ok) {
                  const excelLink = document.createElement("a");
                  excelLink.href = "/download_failed_prompts_excel";
                  excelLink.download = "failed_prompts.xlsx";
                  document.body.appendChild(excelLink);
                  excelLink.click();
                  document.body.removeChild(excelLink);
                }
              })
              .catch(err => console.error("Failed prompt check error:", err));
            setTimeout(() => {
              fetch("/cleanup_files", { method: "POST" })
                .then(res => res.text())
                .then(msg => console.log(msg))
                .catch(err => console.error("Cleanup failed:", err));
              sessionStorage.removeItem("scriptStarted");
            }, 2000);
          }, 2000);
        }
        if (data.includes("Midjourney") && !data.includes("‚úÖ Execution completed.")) {
          scriptJustCompleted = false;
        }
      });
  }, 2000);

  // Mode selection buttons
  const buttons = document.querySelectorAll(".mode-btn");
  const hiddenInput = document.getElementById("selectedMode");
  buttons.forEach(btn => {
    if (btn.getAttribute("data-mode") === hiddenInput.value) {
      btn.classList.add("selected");
    }
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      hiddenInput.value = btn.getAttribute("data-mode");
    });
  });

  document.getElementById("cancel-script-btn").addEventListener("click", () => {
    fetch("/cancel", { method: "POST" })
      .then(response => response.text())
      .then(data => {
        showToast("üõë " + data, "error");
        localStorage.setItem("scriptRunning", "false");
        runBtn.disabled = false;
        runBtn.textContent = "Start";
        clearBtn.disabled = false;
        clearBtn.textContent = "üßπ Clear Output";
        outputCleared = true;
        outputBox.textContent = '';
        const flash = document.getElementById("flash-message");
        if (flash) flash.remove();
      })
      .catch(err => {
        showToast("‚ùå Cancel failed.", "error");
      });
  });
</script>

{% endblock %}
