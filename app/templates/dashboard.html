{% extends "base.html" %}

{% block title %}Dashboard | MidjyAuto{% endblock %}

{% block content %}

<h2 class="title">üìä Dashboard</h2>

<form method="POST" enctype="multipart/form-data" onsubmit="return handleSubmit();">
    <label class="form-label">Upload Prompts File (.xlsx):</label>
    <input type="file" name="prompt_file" id="fileInput" required>

    <label class="form-label" style="margin-top: 30px;">Select Mode:</label>
    <div id="modeButtons" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
        <input type="hidden" name="mode" id="selectedMode" value="{{ selected_mode }}">
        {% for mode in ['U1', 'U2', 'U3', 'U4', 'All'] %}
        <button
            type="button"
            class="mode-btn {% if selected_mode == mode %}selected{% endif %}"
            data-mode="{{ mode }}">{{ mode }}</button>
        {% endfor %}
    </div>

    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
      <button type="submit" id="run-script-btn" class="save-btn">Start</button>
      <button type="button" id="cancel-script-btn" class="save-btn">Cancel</button>
    </div>

      <div id="queue-eta-area" style="text-align:center; margin-top:10px;">
        {% if queue_position is not none and queue_position == 0 %}
          <p><b>Your job is running now! Estimated time remaining: {{ queued_duration }} min (0 / {{ queued_total_prompts }} prompts done).</b></p>
        {% elif queue_position is not none and queue_position > 0 %}
          <p><b>Queued in {{ queued_mode }} ‚Äì position {{ queue_position }}, ~{{ queue_eta_minutes }} min to start</b></p>
        {% else %}
          <p>Not running! Upload an Excel file, select your mode and hit Start.</p>
        {% endif %}
      </div>

    <div id="job-eta-box" style="text-align:center; margin-top:5px;"></div>
</form>

<h3 style="margin-top: 40px;">üñ® Output:</h3>
<div class="output-box" id="outputBox" style="max-width: 800px; max-height: 200px; margin: auto;">Waiting to start...</div>

<button onclick="clearOutput()" class="save-btn" style="margin: 20px auto 0 auto; display: block;">üßπ Clear Output</button>
<div id="status-msg" style="margin-top: 10px; font-style: italic; text-align: center;"></div>
<div id="login-flag" data-just-logged-in="{{ just_logged_in | lower }}"></div>

<audio id="completion-sound" src="{{ url_for('static', filename='completion.mp3') }}" preload="auto" playsinline hidden></audio>

<script>
  let outputCleared = false;
  let suppressDownload = true;
  let isJobRunning = false;
  const justLoggedIn = document.getElementById("login-flag")?.dataset.justLoggedIn === "true";

  if (justLoggedIn && localStorage.getItem("scriptRunning") !== "true") {
    localStorage.setItem("scriptRunning", "false");
    sessionStorage.removeItem("scriptStarted");
  }

  if (sessionStorage.getItem("scriptStarted") === "true") {
    suppressDownload = false;
  }

  if (justLoggedIn) {
    const loginFlagDiv = document.getElementById("login-flag");
    if (loginFlagDiv) {
      loginFlagDiv.dataset.justLoggedIn = "false";
    }
  }

  const runBtn = document.getElementById("run-script-btn");
  const clearBtn = document.querySelector('button[onclick="clearOutput()"]');
  const outputBox = document.getElementById("outputBox");
  let jobProgressInterval = null;
  const completionSound = document.getElementById("completion-sound");
  let audioUnlocked = false;

  function unlockAudio() {
    if (audioUnlocked) return;
    completionSound.play().then(() => {
      completionSound.pause();
      completionSound.currentTime = 0;
      audioUnlocked = true;
    }).catch(() => { /* will retry on next click */ });
  }

  // prime audio on Start click (and first touch)
  runBtn?.addEventListener("click", unlockAudio, { once: false });
  document.addEventListener("touchstart", unlockAudio, { once: true });

  // Live ETA updates from backend via SSE
  const queueSource = new EventSource('/queue_updates');
  queueSource.onmessage = (ev) => {
    try {
      const data = JSON.parse(ev.data);
      let msg = null;
      const mode = document.getElementById("selectedMode")?.value || "";
      if (isJobRunning && (data.num_workers === 0 || data.position == null)) {
        return;
      }
      if (data.position === 0) {
        if (!isJobRunning) {
          isJobRunning = true;
          msg = "<b>Your job is running now!</b>";
          if (!jobProgressInterval) {
            updateJobProgress();
            jobProgressInterval = setInterval(updateJobProgress, 3000);
          }
        }
      } else if (data.position > 0) {
        isJobRunning = false;
        msg = `<b>Queued in ${mode} ‚Äì position ${data.position}, ~${data.eta_minutes} min to start</b>`;
        if (jobProgressInterval) {
          clearInterval(jobProgressInterval);
          jobProgressInterval = null;
        }
      } else if (data.num_workers === 0) {
        isJobRunning = false;
        msg = "<b>Not running! Upload an Excel file, select your mode and hit Start.</b>";
        if (jobProgressInterval) {
          clearInterval(jobProgressInterval);
          jobProgressInterval = null;
        }
      } else {
        isJobRunning = false;
        msg = "<b>Not running! Upload an Excel file, select your mode and hit Start.</b>";
        if (jobProgressInterval) {
          clearInterval(jobProgressInterval);
          jobProgressInterval = null;
        }
      }
      if (msg !== null) {
        document.getElementById("queue-eta-area").innerHTML = "<p>" + msg + "</p>";
      }
    } catch (e) {
      console.error("Queue update failed:", e);
    }
  };


  function updateJobProgress() {
    fetch('/job_progress')
      .then(res => res.json())
      .then(data => {
        const area = document.getElementById("queue-eta-area");
        if (!area) return;
        if (data.status === "running") {
          const min = Math.ceil(data.remaining_seconds / 60);
          area.innerHTML = `<p><b>Your job is running now! Estimated time remaining: ${min} min</b> (${data.completed_prompts} / ${data.total_prompts} prompts done)</p>`;
        } else {
          isJobRunning = false;
          if (jobProgressInterval) {
            clearInterval(jobProgressInterval);
            jobProgressInterval = null;
          }
          area.innerHTML = "<p>Not running! Upload an Excel file, select your mode and hit Start.</p>";
        }
      })
      .catch(() => {
        isJobRunning = false;
        if (jobProgressInterval) {
          clearInterval(jobProgressInterval);
          jobProgressInterval = null;
        }
        const area = document.getElementById("queue-eta-area");
        if (area) {
          area.innerHTML = "<p>Not running! Upload an Excel file, select your mode and hit Start.</p>";
        }
      });
  }



  // Persist state across page reloads using localStorage
  if (localStorage.getItem("scriptRunning") === "true") {
    runBtn.disabled = true;
    runBtn.textContent = "Processing...";
    clearBtn.disabled = true;
    clearBtn.textContent = "Processing...";
  }

  if ({{ start_failed|default(false)|tojson }}) {
    localStorage.setItem("scriptRunning", "false");
    sessionStorage.removeItem("scriptStarted");
    runBtn.disabled = false;
    runBtn.textContent = "Start";
    clearBtn.disabled = false;
    clearBtn.textContent = "üßπ Clear Output";
  }

  function handleSubmit() {
    localStorage.setItem("scriptRunning", "true");
    sessionStorage.setItem("scriptStarted", "true");
    runBtn.disabled = true;
    runBtn.textContent = "Processing...";
    clearBtn.disabled = true;
    clearBtn.textContent = "Processing...";
    return true;
  }

  function clearOutput() {
    outputCleared = true;
    if (localStorage.getItem("scriptRunning") !== "true") {
      outputBox.textContent = '';
    }
  }

  // Poll for log updates
  let scriptJustCompleted = false;

  setInterval(() => {
    if (outputCleared) return;
    fetch("/live_output")
      .then(response => response.text())
      .then(data => {
        outputBox.textContent = data || "Waiting to start...";
        outputBox.scrollTop = outputBox.scrollHeight;

        if (data.includes("‚úÖ Execution completed.") && !scriptJustCompleted) {
          localStorage.setItem("scriptRunning", "false");
          runBtn.disabled = false;
          runBtn.textContent = "Start";
          clearBtn.disabled = false;
          clearBtn.textContent = "üßπ Clear Output";
        }

        // if (data.includes("‚úÖ Execution completed.") && !scriptJustCompleted && !suppressDownload) {
        //   scriptJustCompleted = true;
        //   const flashDiv = document.getElementById("flash-message");
        //   if (flashDiv) flashDiv.remove();
        //   showToast("üü¢ Images have been generated successfully!", "success");
        //   setTimeout(() => {
        //     window.location.href = "/download_zip";


        if (data.includes("‚úÖ Execution completed.") && !scriptJustCompleted && !suppressDownload) {
          scriptJustCompleted = true;

          // Play completion sound
          try {
            completionSound.currentTime = 0;
            completionSound.play().catch(() => {});   // safe if not unlocked
          } catch (e) {}

          const flashDiv = document.getElementById("flash-message");
          if (flashDiv) flashDiv.remove();
          showToast("üü¢ Images have been generated successfully!", "success");

          // setTimeout(() => {
          //   window.location.href = "/download_zip";

          //   fetch("/download_failed_prompts_excel", { method: "HEAD" })
          //     .then(res => {
          //       if (res.ok) {
          //         const excelLink = document.createElement("a");
          //         excelLink.href = "/download_failed_prompts_excel";
          //         excelLink.download = "failed_prompts.xlsx";
          //         document.body.appendChild(excelLink);
          //         excelLink.click();
          //         document.body.removeChild(excelLink);
          //       }
          //     })
          //     .catch(err => console.error("Failed prompt check error:", err));
          //   setTimeout(() => {
          //     fetch("/cleanup_files", { method: "POST" })
          //       .then(res => res.text())
          //       .then(msg => console.log(msg))
          //       .catch(err => console.error("Cleanup failed:", err));

          const zipDownload = fetch("/download_zip")
            .then(res => {
              if (!res.ok) throw new Error("Zip download failed");
              return res.blob();
            })
            .then(blob => {
              const url = window.URL.createObjectURL(blob);
              const link = document.createElement("a");
              link.href = url;
              link.download = "images.zip";
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              window.URL.revokeObjectURL(url);
            })
            .catch(err => console.error("Zip download error:", err));
          const failedExcelDownload = fetch("/download_failed_prompts_excel")
            .then(res => {
              if (!res.ok) throw new Error("Failed prompts file not found");
              return res.blob();
            })
            .then(blob => {
              const url = window.URL.createObjectURL(blob);
              const link = document.createElement("a");
              link.href = url;
              link.download = "failed_prompts.xlsx";
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              window.URL.revokeObjectURL(url);
            })
            .catch(err => console.error("Failed prompt download error:", err));
          const imagesExcelDownload = fetch("/download_images_excel")
            .then(res => {
              if (!res.ok) throw new Error("Images Excel file not found");
              return res.blob();
            })
            .then(blob => {
              const url = window.URL.createObjectURL(blob);
              const link = document.createElement("a");
              link.href = url;
              link.download = "images.xlsx";
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              window.URL.revokeObjectURL(url);
            })
            .catch(err => console.error("Images Excel download error:", err));

          const allDownloads = Promise.all([zipDownload, failedExcelDownload, imagesExcelDownload]);
          const fallback = new Promise(resolve => setTimeout(resolve, 120000));

          Promise.race([allDownloads, fallback])
            .then(() => fetch("/cleanup_files", { method: "POST" }))
            .then(res => res.text())
            .then(msg => console.log(msg))
            .catch(err => console.error("Cleanup failed:", err))
            .finally(() => {
              sessionStorage.removeItem("scriptStarted");
            });
        }
        if (data.includes("Midjourney") && !data.includes("‚úÖ Execution completed.")) {
          scriptJustCompleted = false;
        }
      });
  }, 2000);

  // Mode selection buttons
  const buttons = document.querySelectorAll(".mode-btn");
  const hiddenInput = document.getElementById("selectedMode");
  buttons.forEach(btn => {
    if (btn.getAttribute("data-mode") === hiddenInput.value) {
      btn.classList.add("selected");
    }
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      hiddenInput.value = btn.getAttribute("data-mode");
    });
  });

  document.getElementById("cancel-script-btn").addEventListener("click", () => {
    fetch("/cancel", { method: "POST" })
      .then(response => response.text())
      .then(data => {
        showToast("üõë " + data, "error");
        localStorage.setItem("scriptRunning", "false");
        runBtn.disabled = false;
        runBtn.textContent = "Start";
        clearBtn.disabled = false;
        clearBtn.textContent = "üßπ Clear Output";
        outputCleared = true;
        outputBox.textContent = '';
        const flash = document.getElementById("flash-message");
        if (flash) flash.remove();
      })
      .catch(err => {
        showToast("‚ùå Cancel failed.", "error");
      });
  });
</script>

{% endblock %}
